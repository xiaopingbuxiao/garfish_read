var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));

// src/reactBridge.ts
import * as React from "react";
import * as ReactDOM from "react-dom";
import { warn } from "@garfish/utils";
var defaultOpts = {
  rootComponent: void 0,
  loadRootComponent: void 0,
  renderType: void 0,
  errorBoundary: void 0,
  el: void 0,
  canUpdate: true,
  suppressComponentDidCatchWarning: false,
  domElements: {},
  renderResults: {},
  updateResolves: {}
};
function reactBridge(userOptions) {
  if (typeof userOptions !== "object") {
    throw new Error("garfish-react-bridge requires a configuration object");
  }
  const opts = __spreadValues(__spreadValues({}, defaultOpts), userOptions);
  opts.React = opts.React || React;
  opts.ReactDOM = opts.ReactDOM || ReactDOM;
  if (!opts.rootComponent && !opts.loadRootComponent) {
    throw new Error("garfish-react-bridge must be passed opts.rootComponent or opts.loadRootComponent");
  }
  if (opts.rootComponent && opts.loadRootComponent) {
    warn("garfish-react-bridge: `RootComponent` will be ignored for the reason you have passed both `rootComponent` and `loadRootComponent`.");
  }
  if (opts.errorBoundary && typeof opts.errorBoundary !== "function") {
    throw Error("The errorBoundary opt for garfish-react-bridge must either be omitted or be a function that returns React elements");
  }
  if (!checkReactVersion(opts.React)) {
    throw Error("Please make sure than the react version is higher than or equal to v16 and lower than v18.");
  }
  const providerLifeCycle = {
    render: (appInfo) => mount.call(this, opts, appInfo),
    destroy: (appInfo) => unmount.call(this, opts, appInfo)
  };
  const provider = async function(appInfo, props) {
    await bootstrap.call(this, opts, appInfo, props);
    return providerLifeCycle;
  };
  if (window.__GARFISH__ && typeof __GARFISH_EXPORTS__ === "object" && __GARFISH_EXPORTS__) {
    __GARFISH_EXPORTS__.provider = provider;
  }
  return provider;
}
function bootstrap(opts, appInfo, props) {
  if (opts.loadRootComponent) {
    try {
      return opts.loadRootComponent(__spreadProps(__spreadValues({}, appInfo), {
        props
      })).then((resolvedComponent) => {
        opts.rootComponent = resolvedComponent;
      });
    } catch (error) {
      console.error("error log by garfish: loadRootComponent error:", error);
      throw new Error(error);
    }
  } else {
    return Promise.resolve();
  }
}
function mount(opts, appInfo) {
  if (!opts.suppressComponentDidCatchWarning && checkReactVersion(opts.React) && !opts.errorBoundary) {
    if (opts.rootComponent && !opts.rootComponent.prototype) {
      warn(`garfish-react-bridge: ${appInfo.appName}'s rootComponent does not implement an error boundary.  If using a functional component, consider providing an opts.errorBoundary to reactBridge(opts).`);
    } else if (opts.rootComponent && !opts.rootComponent.prototype.componentDidCatch) {
      warn(`garfish-react-bridge: ${appInfo.appName}'s rootComponent should implement componentDidCatch to avoid accidentally unmounting the entire garfish application.`);
    }
  }
  const elementToRender = getElementToRender(opts, appInfo);
  const domElement = chooseDomElementGetter(opts, appInfo);
  const renderResult = reactDomRender({
    elementToRender,
    domElement,
    opts
  });
  opts.domElements ? opts.domElements[appInfo.appName] = domElement : "";
}
function unmount(opts, appInfo) {
  if (opts.domElements) {
    opts.ReactDOM && opts.ReactDOM.unmountComponentAtNode(opts.domElements[appInfo.appName]);
    delete opts.domElements[appInfo.appName];
  }
}
function checkReactVersion(React2) {
  if (React2 && typeof React2.version === "string" && React2.version.indexOf(".") >= 0) {
    const majorVersionString = React2.version.split(".")[0];
    try {
      return Number(majorVersionString) >= 16 && Number(majorVersionString) < 18;
    } catch (err) {
      return false;
    }
  } else {
    return false;
  }
}
function reactDomRender({ opts, elementToRender, domElement }) {
  const renderType = typeof opts.renderType === "function" ? opts.renderType() : opts.renderType;
  if (renderType === "hydrate") {
    opts.ReactDOM.hydrate(elementToRender, domElement);
  } else {
    opts.ReactDOM.render(elementToRender, domElement);
  }
  return null;
}
function getElementToRender(opts, appInfo) {
  if (opts.React) {
    const rootComponentElement = opts.React.createElement(opts.rootComponent, appInfo);
    let elementToRender = rootComponentElement;
    if (opts.errorBoundary) {
      elementToRender = opts.React.createElement(createErrorBoundary(opts), appInfo, elementToRender);
    }
    return rootComponentElement;
  }
}
function createErrorBoundary(opts) {
  function GarfishSubAppReactErrorBoundary(props) {
    opts.React && opts.React.Component.apply(this, arguments);
    this.state = {
      caughtError: null,
      caughtErrorInfo: null
    };
    GarfishSubAppReactErrorBoundary.displayName = `ReactBridgeReactErrorBoundary(${props.name})`;
  }
  GarfishSubAppReactErrorBoundary.prototype = opts.React && Object.create(opts.React.Component.prototype);
  GarfishSubAppReactErrorBoundary.prototype.render = function() {
    if (this.state.caughtError) {
      const errorBoundary = opts.errorBoundary;
      return errorBoundary && errorBoundary(this.state.caughtError, this.props);
    } else {
      return this.props.children;
    }
  };
  GarfishSubAppReactErrorBoundary.prototype.componentDidCatch = function(err, info) {
    this.setState({
      caughtError: err,
      caughtErrorInfo: info
    });
  };
  return GarfishSubAppReactErrorBoundary;
}
function chooseDomElementGetter(opts, appInfo) {
  const { dom: container } = appInfo;
  let el;
  if (typeof opts.el === "string") {
    el = container.querySelector(opts.el);
  } else {
    el = container;
  }
  if (!(el instanceof HTMLElement)) {
    throw Error(`react bridge's dom-element-getter-helpers: el is an invalid dom element for application'${appInfo.appName}'. Expected HTMLElement, received ${typeof el}`);
  }
  return el;
}
export {
  reactBridge
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL3JlYWN0QnJpZGdlLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvLyBUaGUgbG9naWMgb2YgcmVhY3RCcmlkZ2UgaXMgcmVmZXJlbmNlZCBmcm9tIHNpbmdsZS1zcGEgdHlwb2dyYXBoeVxuLy8gQmVjYXVzZSB0aGUgR2FyZmlzaCBsaWZlY3ljbGUgZG9lcyBub3QgYWdyZWUgd2l0aCB0aGF0IG9mIHNpbmdsZS1zcGEgIHBhcnQgbG9naWNhbCBjb3VwbGluZyBpbiB0aGUgZnJhbWV3b3JrXG4vLyBodHRwczovL2dpdGh1Yi5jb20vc2luZ2xlLXNwYS9zaW5nbGUtc3BhLXJlYWN0L2Jsb2IvbWFpbi9zcmMvc2luZ2xlLXNwYS1yZWFjdC5qc1xuXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgKiBhcyBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20nO1xuaW1wb3J0IHR5cGUgeyBVc2VyT3B0aW9ucywgUHJvcHNJbmZvIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyB3YXJuIH0gZnJvbSAnQGdhcmZpc2gvdXRpbHMnO1xuXG50eXBlIHR5cGVSZWFjdCA9IHR5cGVvZiBSZWFjdCB8IHVuZGVmaW5lZDtcbnR5cGUgT3B0aW9ucyA9IFVzZXJPcHRpb25zPHR5cGVvZiBSZWFjdCwgdHlwZW9mIFJlYWN0RE9NLCBhbnksIFJlYWN0LlJlYWN0Tm9kZT47XG5cbmNvbnN0IGRlZmF1bHRPcHRzID0ge1xuICAvLyByZXF1aXJlZCAtIG9uZSBvciB0aGUgb3RoZXIgb3IgYm90aFxuICByb290Q29tcG9uZW50OiB1bmRlZmluZWQsXG4gIGxvYWRSb290Q29tcG9uZW50OiB1bmRlZmluZWQsXG5cbiAgLy8gb3B0aW9uYWwgb3B0c1xuICByZW5kZXJUeXBlOiB1bmRlZmluZWQsXG4gIGVycm9yQm91bmRhcnk6IHVuZGVmaW5lZCxcbiAgZWw6IHVuZGVmaW5lZCxcbiAgY2FuVXBkYXRlOiB0cnVlLCAvLyBieSBkZWZhdWx0LCBhbGxvdyBwYXJjZWxzIGNyZWF0ZWQgd2l0aCBnYXJmaXNoLXJlYWN0LWJyaWRnZSB0byBiZSB1cGRhdGVkXG4gIHN1cHByZXNzQ29tcG9uZW50RGlkQ2F0Y2hXYXJuaW5nOiBmYWxzZSxcbiAgZG9tRWxlbWVudHM6IHt9LFxuICByZW5kZXJSZXN1bHRzOiB7fSxcbiAgdXBkYXRlUmVzb2x2ZXM6IHt9LFxufTtcblxuZGVjbGFyZSBjb25zdCBfX0dBUkZJU0hfRVhQT1JUU19fOiB7XG4gIHByb3ZpZGVyOiBPYmplY3Q7XG59O1xuXG5kZWNsYXJlIGdsb2JhbCB7XG4gIGludGVyZmFjZSBXaW5kb3cge1xuICAgIF9fR0FSRklTSF9fOiBib29sZWFuO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFjdEJyaWRnZSh0aGlzOiBhbnksIHVzZXJPcHRpb25zOiBPcHRpb25zKSB7XG4gIGlmICh0eXBlb2YgdXNlck9wdGlvbnMgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdnYXJmaXNoLXJlYWN0LWJyaWRnZSByZXF1aXJlcyBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0Jyk7XG4gIH1cblxuICBjb25zdCBvcHRzOiBPcHRpb25zID0ge1xuICAgIC4uLmRlZmF1bHRPcHRzLFxuICAgIC4uLnVzZXJPcHRpb25zLFxuICB9O1xuXG4gIG9wdHMuUmVhY3QgPSBvcHRzLlJlYWN0IHx8IFJlYWN0O1xuICBvcHRzLlJlYWN0RE9NID0gb3B0cy5SZWFjdERPTSB8fCBSZWFjdERPTTtcblxuICBpZiAoIW9wdHMucm9vdENvbXBvbmVudCAmJiAhb3B0cy5sb2FkUm9vdENvbXBvbmVudCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdnYXJmaXNoLXJlYWN0LWJyaWRnZSBtdXN0IGJlIHBhc3NlZCBvcHRzLnJvb3RDb21wb25lbnQgb3Igb3B0cy5sb2FkUm9vdENvbXBvbmVudCcsXG4gICAgKTtcbiAgfVxuXG4gIGlmIChvcHRzLnJvb3RDb21wb25lbnQgJiYgb3B0cy5sb2FkUm9vdENvbXBvbmVudCkge1xuICAgIHdhcm4oXG4gICAgICAnZ2FyZmlzaC1yZWFjdC1icmlkZ2U6IGBSb290Q29tcG9uZW50YCB3aWxsIGJlIGlnbm9yZWQgZm9yIHRoZSByZWFzb24geW91IGhhdmUgcGFzc2VkIGJvdGggYHJvb3RDb21wb25lbnRgIGFuZCBgbG9hZFJvb3RDb21wb25lbnRgLicsXG4gICAgKTtcbiAgfVxuXG4gIGlmIChvcHRzLmVycm9yQm91bmRhcnkgJiYgdHlwZW9mIG9wdHMuZXJyb3JCb3VuZGFyeSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIHRocm93IEVycm9yKFxuICAgICAgJ1RoZSBlcnJvckJvdW5kYXJ5IG9wdCBmb3IgZ2FyZmlzaC1yZWFjdC1icmlkZ2UgbXVzdCBlaXRoZXIgYmUgb21pdHRlZCBvciBiZSBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBSZWFjdCBlbGVtZW50cycsXG4gICAgKTtcbiAgfVxuICBpZiAoIWNoZWNrUmVhY3RWZXJzaW9uKG9wdHMuUmVhY3QpKSB7XG4gICAgdGhyb3cgRXJyb3IoXG4gICAgICAnUGxlYXNlIG1ha2Ugc3VyZSB0aGFuIHRoZSByZWFjdCB2ZXJzaW9uIGlzIGhpZ2hlciB0aGFuIG9yIGVxdWFsIHRvIHYxNiBhbmQgbG93ZXIgdGhhbiB2MTguJyxcbiAgICApO1xuICB9XG5cbiAgY29uc3QgcHJvdmlkZXJMaWZlQ3ljbGUgPSB7XG4gICAgcmVuZGVyOiAoYXBwSW5mbykgPT4gbW91bnQuY2FsbCh0aGlzLCBvcHRzLCBhcHBJbmZvKSxcbiAgICBkZXN0cm95OiAoYXBwSW5mbykgPT4gdW5tb3VudC5jYWxsKHRoaXMsIG9wdHMsIGFwcEluZm8pLFxuICAgIC8vIHVwZGF0ZTogKGFwcEluZm8pID0+IG9wdHMuY2FuVXBkYXRlICYmIHVwZGF0ZS5jYWxsKHRoaXMsIG9wdHMsIGFwcEluZm8pLFxuICB9O1xuXG4gIGNvbnN0IHByb3ZpZGVyID0gYXN5bmMgZnVuY3Rpb24gKHRoaXM6IGFueSwgYXBwSW5mbywgcHJvcHMpIHtcbiAgICBhd2FpdCBib290c3RyYXAuY2FsbCh0aGlzLCBvcHRzLCBhcHBJbmZvLCBwcm9wcyk7XG4gICAgcmV0dXJuIHByb3ZpZGVyTGlmZUN5Y2xlO1xuICB9O1xuXG4gIGlmIChcbiAgICB3aW5kb3cuX19HQVJGSVNIX18gJiZcbiAgICB0eXBlb2YgX19HQVJGSVNIX0VYUE9SVFNfXyA9PT0gJ29iamVjdCcgJiZcbiAgICBfX0dBUkZJU0hfRVhQT1JUU19fXG4gICkge1xuICAgIF9fR0FSRklTSF9FWFBPUlRTX18ucHJvdmlkZXIgPSBwcm92aWRlcjtcbiAgfVxuICByZXR1cm4gcHJvdmlkZXI7XG59XG5cbmZ1bmN0aW9uIGJvb3RzdHJhcChvcHRzOiBPcHRpb25zLCBhcHBJbmZvOiBQcm9wc0luZm8sIHByb3BzKSB7XG4gIGlmIChvcHRzLmxvYWRSb290Q29tcG9uZW50KSB7XG4gICAgLy8gVGhleSBwYXNzZWQgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCB0aGUgcmVhY3QgY29tcG9uZW50LiBXYWl0IGZvciBpdCB0byByZXNvbHZlIGJlZm9yZSBtb3VudGluZ1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gb3B0c1xuICAgICAgICAubG9hZFJvb3RDb21wb25lbnQoe1xuICAgICAgICAgIC4uLmFwcEluZm8sXG4gICAgICAgICAgcHJvcHMsXG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKChyZXNvbHZlZENvbXBvbmVudCkgPT4ge1xuICAgICAgICAgIG9wdHMucm9vdENvbXBvbmVudCA9IHJlc29sdmVkQ29tcG9uZW50O1xuICAgICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignZXJyb3IgbG9nIGJ5IGdhcmZpc2g6IGxvYWRSb290Q29tcG9uZW50IGVycm9yOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIFRoaXMgaXMgYSBjbGFzcyBvciBzdGF0ZWxlc3MgZnVuY3Rpb24gY29tcG9uZW50XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIG1vdW50KG9wdHM6IE9wdGlvbnMsIGFwcEluZm86IFByb3BzSW5mbykge1xuICBpZiAoXG4gICAgIW9wdHMuc3VwcHJlc3NDb21wb25lbnREaWRDYXRjaFdhcm5pbmcgJiZcbiAgICBjaGVja1JlYWN0VmVyc2lvbihvcHRzLlJlYWN0KSAmJlxuICAgICFvcHRzLmVycm9yQm91bmRhcnlcbiAgKSB7XG4gICAgaWYgKG9wdHMucm9vdENvbXBvbmVudCAmJiAhb3B0cy5yb290Q29tcG9uZW50LnByb3RvdHlwZSkge1xuICAgICAgd2FybihcbiAgICAgICAgYGdhcmZpc2gtcmVhY3QtYnJpZGdlOiAke2FwcEluZm8uYXBwTmFtZX0ncyByb290Q29tcG9uZW50IGRvZXMgbm90IGltcGxlbWVudCBhbiBlcnJvciBib3VuZGFyeS4gIElmIHVzaW5nIGEgZnVuY3Rpb25hbCBjb21wb25lbnQsIGNvbnNpZGVyIHByb3ZpZGluZyBhbiBvcHRzLmVycm9yQm91bmRhcnkgdG8gcmVhY3RCcmlkZ2Uob3B0cykuYCxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIG9wdHMucm9vdENvbXBvbmVudCAmJlxuICAgICAgIW9wdHMucm9vdENvbXBvbmVudC5wcm90b3R5cGUuY29tcG9uZW50RGlkQ2F0Y2hcbiAgICApIHtcbiAgICAgIHdhcm4oXG4gICAgICAgIGBnYXJmaXNoLXJlYWN0LWJyaWRnZTogJHthcHBJbmZvLmFwcE5hbWV9J3Mgcm9vdENvbXBvbmVudCBzaG91bGQgaW1wbGVtZW50IGNvbXBvbmVudERpZENhdGNoIHRvIGF2b2lkIGFjY2lkZW50YWxseSB1bm1vdW50aW5nIHRoZSBlbnRpcmUgZ2FyZmlzaCBhcHBsaWNhdGlvbi5gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBlbGVtZW50VG9SZW5kZXIgPSBnZXRFbGVtZW50VG9SZW5kZXIob3B0cywgYXBwSW5mbyk7XG4gIGNvbnN0IGRvbUVsZW1lbnQgPSBjaG9vc2VEb21FbGVtZW50R2V0dGVyKG9wdHMsIGFwcEluZm8pO1xuICBjb25zdCByZW5kZXJSZXN1bHQgPSByZWFjdERvbVJlbmRlcih7XG4gICAgZWxlbWVudFRvUmVuZGVyLFxuICAgIGRvbUVsZW1lbnQsXG4gICAgb3B0cyxcbiAgfSk7XG4gIG9wdHMuZG9tRWxlbWVudHMgPyAob3B0cy5kb21FbGVtZW50c1thcHBJbmZvLmFwcE5hbWVdID0gZG9tRWxlbWVudCkgOiAnJztcbiAgLy8gb3B0cy5yZW5kZXJSZXN1bHRzW2FwcEluZm8uYXBwTmFtZV0gPSByZW5kZXJSZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIHVubW91bnQob3B0czogT3B0aW9ucywgYXBwSW5mbzogUHJvcHNJbmZvKSB7XG4gIGlmIChvcHRzLmRvbUVsZW1lbnRzKSB7XG4gICAgb3B0cy5SZWFjdERPTSAmJlxuICAgICAgb3B0cy5SZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKG9wdHMuZG9tRWxlbWVudHNbYXBwSW5mby5hcHBOYW1lXSk7XG4gICAgZGVsZXRlIG9wdHMuZG9tRWxlbWVudHNbYXBwSW5mby5hcHBOYW1lXTtcbiAgICAvLyBkZWxldGUgb3B0cy5yZW5kZXJSZXN1bHRzW2FwcEluZm8uYXBwTmFtZV07XG4gIH1cbn1cblxuLy8gZnVuY3Rpb24gdXBkYXRlKG9wdHMsIGFwcEluZm86IFByb3BzSW5mbykge1xuLy8gICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbi8vICAgICBpZiAoIW9wdHMudXBkYXRlUmVzb2x2ZXNbYXBwSW5mby5hcHBOYW1lXSkge1xuLy8gICAgICAgb3B0cy51cGRhdGVSZXNvbHZlc1thcHBJbmZvLmFwcE5hbWVdID0gW107XG4vLyAgICAgfVxuXG4vLyAgICAgb3B0cy51cGRhdGVSZXNvbHZlc1thcHBJbmZvLmFwcE5hbWVdLnB1c2gocmVzb2x2ZSk7XG5cbi8vICAgICBjb25zdCBlbGVtZW50VG9SZW5kZXIgPSBnZXRFbGVtZW50VG9SZW5kZXIob3B0cywgYXBwSW5mbyk7XG4vLyAgICAgY29uc3QgZG9tRWxlbWVudCA9IGNob29zZURvbUVsZW1lbnRHZXR0ZXIob3B0cywgYXBwSW5mbyk7XG5cbi8vICAgICAvLyBUaGlzIGlzIHRoZSBvbGQgd2F5IHRvIHVwZGF0ZSBhIHJlYWN0IGFwcGxpY2F0aW9uIC0ganVzdCBjYWxsIHJlbmRlcigpIGFnYWluXG4vLyAgICAgb3B0cy5SZWFjdERPTS5yZW5kZXIoZWxlbWVudFRvUmVuZGVyLCBkb21FbGVtZW50KTtcbi8vICAgfSk7XG4vLyB9XG5cbmZ1bmN0aW9uIGNoZWNrUmVhY3RWZXJzaW9uKFJlYWN0OiB0eXBlUmVhY3QpIHtcbiAgaWYgKFxuICAgIFJlYWN0ICYmXG4gICAgdHlwZW9mIFJlYWN0LnZlcnNpb24gPT09ICdzdHJpbmcnICYmXG4gICAgUmVhY3QudmVyc2lvbi5pbmRleE9mKCcuJykgPj0gMFxuICApIHtcbiAgICBjb25zdCBtYWpvclZlcnNpb25TdHJpbmcgPSBSZWFjdC52ZXJzaW9uLnNwbGl0KCcuJylbMF07XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIE51bWJlcihtYWpvclZlcnNpb25TdHJpbmcpID49IDE2ICYmIE51bWJlcihtYWpvclZlcnNpb25TdHJpbmcpIDwgMThcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZWFjdERvbVJlbmRlcih7IG9wdHMsIGVsZW1lbnRUb1JlbmRlciwgZG9tRWxlbWVudCB9KSB7XG4gIGNvbnN0IHJlbmRlclR5cGUgPVxuICAgIHR5cGVvZiBvcHRzLnJlbmRlclR5cGUgPT09ICdmdW5jdGlvbicgPyBvcHRzLnJlbmRlclR5cGUoKSA6IG9wdHMucmVuZGVyVHlwZTtcblxuICBpZiAocmVuZGVyVHlwZSA9PT0gJ2h5ZHJhdGUnKSB7XG4gICAgb3B0cy5SZWFjdERPTS5oeWRyYXRlKGVsZW1lbnRUb1JlbmRlciwgZG9tRWxlbWVudCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gZGVmYXVsdCB0byB0aGlzIGlmICdyZW5kZXJUeXBlJyBpcyBudWxsIG9yIGRvZXNuJ3QgbWF0Y2ggdGhlIG90aGVyIG9wdGlvbnNcbiAgICBvcHRzLlJlYWN0RE9NLnJlbmRlcihlbGVtZW50VG9SZW5kZXIsIGRvbUVsZW1lbnQpO1xuICB9XG4gIC8vIFRoZSByZWFjdERvbVJlbmRlciBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIGEgcmVhY3Qgcm9vdCwgYnV0IFJlYWN0RE9NLmh5ZHJhdGUoKSBhbmQgUmVhY3RET00ucmVuZGVyKClcbiAgLy8gZG8gbm90IHJldHVybiBhIHJlYWN0IHJvb3QuIFNvIGluc3RlYWQsIHdlIHJldHVybiBudWxsIHdoaWNoIGluZGljYXRlcyB0aGF0IHRoZXJlIGlzIG5vIHJlYWN0IHJvb3RcbiAgLy8gdGhhdCBjYW4gYmUgdXNlZCBmb3IgdXBkYXRlcyBvciB1bm1vdW50aW5nXG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBnZXRFbGVtZW50VG9SZW5kZXIob3B0czogT3B0aW9ucywgYXBwSW5mbzogUHJvcHNJbmZvKSB7XG4gIGlmIChvcHRzLlJlYWN0KSB7XG4gICAgY29uc3Qgcm9vdENvbXBvbmVudEVsZW1lbnQgPSBvcHRzLlJlYWN0LmNyZWF0ZUVsZW1lbnQoXG4gICAgICBvcHRzLnJvb3RDb21wb25lbnQsXG4gICAgICBhcHBJbmZvLFxuICAgICk7XG4gICAgbGV0IGVsZW1lbnRUb1JlbmRlciA9IHJvb3RDb21wb25lbnRFbGVtZW50O1xuXG4gICAgaWYgKG9wdHMuZXJyb3JCb3VuZGFyeSkge1xuICAgICAgZWxlbWVudFRvUmVuZGVyID0gb3B0cy5SZWFjdC5jcmVhdGVFbGVtZW50KFxuICAgICAgICBjcmVhdGVFcnJvckJvdW5kYXJ5KG9wdHMpIGFzIGFueSxcbiAgICAgICAgYXBwSW5mbyxcbiAgICAgICAgZWxlbWVudFRvUmVuZGVyLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHJvb3RDb21wb25lbnRFbGVtZW50O1xuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUVycm9yQm91bmRhcnkob3B0czogT3B0aW9ucykge1xuICAvLyBBdm9pZGluZyBiYWJlbCBvdXRwdXQgZm9yIGNsYXNzIHN5bnRheCBhbmQgc3VwZXIoKVxuICAvLyB0byBhdm9pZCBibG9hdFxuICBmdW5jdGlvbiBHYXJmaXNoU3ViQXBwUmVhY3RFcnJvckJvdW5kYXJ5KHRoaXM6IGFueSwgcHJvcHMpIHtcbiAgICAvLyBzdXBlclxuICAgIG9wdHMuUmVhY3QgJiYgb3B0cy5SZWFjdC5Db21wb25lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcblxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBjYXVnaHRFcnJvcjogbnVsbCxcbiAgICAgIGNhdWdodEVycm9ySW5mbzogbnVsbCxcbiAgICB9O1xuXG4gICAgKFxuICAgICAgR2FyZmlzaFN1YkFwcFJlYWN0RXJyb3JCb3VuZGFyeSBhcyBhbnlcbiAgICApLmRpc3BsYXlOYW1lID0gYFJlYWN0QnJpZGdlUmVhY3RFcnJvckJvdW5kYXJ5KCR7cHJvcHMubmFtZX0pYDtcbiAgfVxuXG4gIEdhcmZpc2hTdWJBcHBSZWFjdEVycm9yQm91bmRhcnkucHJvdG90eXBlID1cbiAgICBvcHRzLlJlYWN0ICYmIE9iamVjdC5jcmVhdGUob3B0cy5SZWFjdC5Db21wb25lbnQucHJvdG90eXBlKTtcblxuICBHYXJmaXNoU3ViQXBwUmVhY3RFcnJvckJvdW5kYXJ5LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUuY2F1Z2h0RXJyb3IpIHtcbiAgICAgIGNvbnN0IGVycm9yQm91bmRhcnkgPSBvcHRzLmVycm9yQm91bmRhcnk7XG4gICAgICByZXR1cm4gZXJyb3JCb3VuZGFyeSAmJiBlcnJvckJvdW5kYXJ5KHRoaXMuc3RhdGUuY2F1Z2h0RXJyb3IsIHRoaXMucHJvcHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5jaGlsZHJlbjtcbiAgICB9XG4gIH07XG5cbiAgR2FyZmlzaFN1YkFwcFJlYWN0RXJyb3JCb3VuZGFyeS5wcm90b3R5cGUuY29tcG9uZW50RGlkQ2F0Y2ggPSBmdW5jdGlvbiAoXG4gICAgZXJyLFxuICAgIGluZm8sXG4gICkge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgY2F1Z2h0RXJyb3I6IGVycixcbiAgICAgIGNhdWdodEVycm9ySW5mbzogaW5mbyxcbiAgICB9KTtcbiAgfTtcblxuICByZXR1cm4gR2FyZmlzaFN1YkFwcFJlYWN0RXJyb3JCb3VuZGFyeTtcbn1cblxuZnVuY3Rpb24gY2hvb3NlRG9tRWxlbWVudEdldHRlcihvcHRzOiBPcHRpb25zLCBhcHBJbmZvOiBQcm9wc0luZm8pIHtcbiAgY29uc3QgeyBkb206IGNvbnRhaW5lciB9ID0gYXBwSW5mbztcbiAgbGV0IGVsO1xuICBpZiAodHlwZW9mIG9wdHMuZWwgPT09ICdzdHJpbmcnKSB7XG4gICAgZWwgPSBjb250YWluZXIucXVlcnlTZWxlY3RvcihvcHRzLmVsKTtcbiAgfSBlbHNlIHtcbiAgICBlbCA9IGNvbnRhaW5lcjtcbiAgfVxuXG4gIGlmICghKGVsIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XG4gICAgdGhyb3cgRXJyb3IoXG4gICAgICBgcmVhY3QgYnJpZGdlJ3MgZG9tLWVsZW1lbnQtZ2V0dGVyLWhlbHBlcnM6IGVsIGlzIGFuIGludmFsaWQgZG9tIGVsZW1lbnQgZm9yIGFwcGxpY2F0aW9uJyR7XG4gICAgICAgIGFwcEluZm8uYXBwTmFtZVxuICAgICAgfScuIEV4cGVjdGVkIEhUTUxFbGVtZW50LCByZWNlaXZlZCAke3R5cGVvZiBlbH1gLFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGVsO1xufVxuIl0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSUE7QUFDQTtBQUVBO0FBS0EsSUFBTSxjQUFjO0FBQUEsRUFFbEIsZUFB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
